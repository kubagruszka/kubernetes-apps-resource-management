= Test configurations

In the previous examples we used the autogenerated files for deploying to Kubernetes/OpenShift.
However, when moving towards production environment is unlikely for your deployments to be controled only using those configurations.

A common practice is to create a dedicated folder for the Kubernetes/OpenShift YAML resources and leave the pipelines to customize those definitions upon interacting with different namespace/project setup.

Let's setup such a folder in `src/main` and name it  `k8s`.

== Integration tests to avoid problems

In this folder `src/main/k8s` add `dc.yml` file with the following content:

[.console-input]
[source,bash]
----
apiVersion: apps.openshift.io/v1
kind: DeploymentConfig
metadata:
  annotations:
    app.openshift.io/vcs-url: <<unknown>>
    app.quarkus.io/build-timestamp: 2021-09-03 - 11:21:19 +0000
  labels:
    app.openshift.io/runtime: quarkus
    app.kubernetes.io/version: 1.0-SNAPSHOT
    app.kubernetes.io/name: greeting-app
  name: greeting-app
spec:
  replicas: 1
  selector:
    app.kubernetes.io/version: 1.0-SNAPSHOT
    app.kubernetes.io/name: greeting-app
  template:
    metadata:
      annotations:
        app.openshift.io/vcs-url: <<unknown>>
        app.quarkus.io/build-timestamp: 2021-09-03 - 11:21:19 +0000
      labels:
        app.openshift.io/runtime: quarkus
        app.kubernetes.io/version: 1.0-SNAPSHOT
        app.kubernetes.io/name: greeting-app
    spec:
      containers:
          image: quay.io/anasandbox/greeting-app:1.0-SNAPSHOT
          imagePullPolicy: IfNotPresent
          livenessProbe:
            failureThreshold: 3
            httpGet:
              path: /health/live
              port: 8080
              scheme: HTTP
            initialDelaySeconds: 0
            periodSeconds: 30
            successThreshold: 1
            timeoutSeconds: 10
          name: greeting-app
          ports:
            - containerPort: 8080
              name: http
              protocol: TCP
          readinessProbe:
            failureThreshold: 3
            httpGet:
              path: /health/ready
              port: 8080
              scheme: HTTP
            initialDelaySeconds: 0
            periodSeconds: 30
            successThreshold: 1
            timeoutSeconds: 10
          resources:
            limits:
              cpu: 200m
              memory: 230Mi
            requests:
              cpu: 100m
              memory: 115Mi
      serviceAccount: greeting-app
  triggers:
    - imageChangeParams:
        automatic: true
        containerNames:
          - greeting-app
        from:
          kind: ImageStreamTag
          name: greeting-app:1.0.0-SNAPSHOT
      type: ImageChange
----

Typically you will install `src/main/k8s/dc.yml` in an OpenShift environment and will observe that the configuration is rejected.
However, you can avoid reaching deployment time to realize that by creating an integration test using `quarkus-test-openshift-client`.

Simply add the following `pom.xml` snippet to the project:

[.console-input]
[source,xml]
----
    <dependency>
      <groupId>io.quarkus</groupId>
      <artifactId>quarkus-test-openshift-client</artifactId>
      <scope>test</scope>
    </dependency>
----

Now let's create an integration test for the `DeploymentConfig` resource defined in the file:

[.console-input]
[source,java]
----
package com.redhat.developers;

import io.fabric8.kubernetes.client.KubernetesClientException;
import io.fabric8.openshift.client.server.mock.OpenShiftServer;
import io.quarkus.test.junit.QuarkusTest;
import io.quarkus.test.kubernetes.client.OpenShiftTestServer;
import io.quarkus.test.kubernetes.client.WithOpenShiftTestServer;
import org.junit.jupiter.api.Test;

import java.net.URISyntaxException;

import static org.junit.jupiter.api.Assertions.assertThrows;


@WithOpenShiftTestServer//<1>
@QuarkusTest
public class DeploymentConfigClientTest {

    @OpenShiftTestServer
    private OpenShiftServer mockOpenShiftServer; //<2>

    private String pathToDeploymentConfig;

    @Test
    public void testDeploymentConfigFile() throws URISyntaxException {
        pathToDeploymentConfig = "./src/main/k8s/dc.yml"; <3>
        assertThrows(KubernetesClientException.class, () -> mockOpenShiftServer.getOpenshiftClient().deploymentConfigs().load(pathToDeploymentConfig).dryRun()) ; <4>
    }

}
----
<1> Annotate the test as one working in OpenShift context.
<2> Add the mock OpenShift context.
<3> Specify the path to the resource under test.
<4> Dry run the installation of the resource present in the file.

By running the test (via ContinuousTesting/IDE/application package) you will get an exception but also what is wrong with the resource.