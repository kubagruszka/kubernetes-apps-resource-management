<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Bonus:Protecting Critical Deployments :: Efficient Resource Management with Kubernetes</title>
    <link rel="canonical" href="https://redhat-scholars.github.io/kubernetes-apps-resource-management/main/7critical.html">
    <link rel="prev" href="6monitoring.html">
    <meta name="generator" content="Antora 3.0.0">
    <link rel="stylesheet" href="../../_/css/site.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img src="../../_/img/NewRHDFullLogo_4-color_white-wordmark.png" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="https://redhat-scholars.github.io">Efficient Resource Management with Kubernetes</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://developers.redhat.com/ebooks/" target="_blank">Books</a>
        <a class="navbar-item" href="https://developers.redhat.com/cheatsheets/" target="_blank">Cheat Sheets</a>
        <a class="navbar-item" href="https://developers.redhat.com/events/" target="_blank">Upcoming Events</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/kubernetes-tutorial/" target="_blank">Kubernetes</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/istio-tutorial/" target="_blank">Istio</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/quarkus-tutorial/" target="_blank">Quarkus</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/knative-tutorial/" target="_blank">Knative</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/tekton-tutorial/" target="_blank">Tekton</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="kubernetes-apps-resource-management" data-version="main">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html"></a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="1setup.html">Setup</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="2starter.html">Starter Project</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="3deploy.html">Deploy</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="3deploy.html#deploydb">Deploy Database</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="3deploy.html#deployapp">Deploy Application</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="3deploy.html#accessingservice">Accessing Application</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="3deploy.html#deployhowto">Bonus Track: How to develop the app</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="4resources.html">Resource Quotas</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="4resources.html#resourcediscovering">Discovering Resource Limits</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="4resources.html#resourcejvmergonomics">JVM Ergonomics</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="4resources.html#resourceadjustcontainer">Adjusting Container Resources</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="4resources.html#resourcefinal">Final Words</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="4resources.html#resourcehowto">Bonus Track: Setting Kubernetes values in Quarkus</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="5metrics.html">Tailor metrics</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="5metrics.html#metricsquarkus">Metrics in Quarkus</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="5metrics.html#metricsprometheus">Inspect metrics in Prometheus</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="6monitoring.html">Observing Memory/CPU</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="6monitoring.html#monitoringrequestlimits">Understanding requests and limits</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="6monitoring.html#monitoringprometheus">Using Prometheus to size/update memory limits</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="6monitoring.html#monitoringovercommiting">Overcomiting</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="6monitoring.html#monitoringbonustrack">Bonus Track: Automatic Requests and Limits</a>
  </li>
</ul>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="7critical.html">Bonus:Protecting Critical Deployments</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#kube-integration-tests">Integration tests to avoid Kubernetes YAML issues</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Efficient Resource Management with Kubernetes</a></li>
    <li><a href="7critical.html">Bonus:Protecting Critical Deployments</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/redhat-scholars/kubernetes-apps-resource-management/edit/main/documentation/modules/ROOT/pages/7critical.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">Bonus:Protecting Critical Deployments</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>In the previous examples we used some autogenerated files together with YAML fragments defined in <code>src/main/kubernetes</code> for deploying to Kubernetes/OpenShift.
As involuntary mistakes can occur in manually created YAML files, it would be great to test those before applying them in any namespace.</p>
</div>
<div class="paragraph">
<p>To make testing against a mock Kubernetes API extremely simple, Quarkus provides the <code>WithKubernetesTestServer</code> annotation which automatically launches a mock of the Kubernetes API server and sets the proper environment variables needed.
To take advantage of these features, the <code>quarkus-test-kubernetes-client</code> dependency needs to be added in <code>pom.xml</code>:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">    &lt;dependency&gt;
      &lt;groupId&gt;io.quarkus&lt;/groupId&gt;
      &lt;artifactId&gt;quarkus-test-kubernetes-client&lt;/artifactId&gt;
      &lt;scope&gt;test&lt;/scope&gt;
    &lt;/dependency&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="kube-integration-tests"><a class="anchor" href="#kube-integration-tests"></a>Integration tests to avoid Kubernetes YAML issues</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A <code>PodDisruptionBudget</code> is a Kubernetes resource you can define to protect your critical workloads against voluntary disruptions like:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>deleting the deployment that manages the pod</p>
</li>
<li>
<p>directly deleting a pod that is not managed by a Deployment resource</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can create a <code>PodDisruptionBudget</code> for workloads encapsulated in other Kubernetes resources like <code>Deployment</code>, <code>ReplicaSet</code>, <code>StatefulSet</code>.</p>
</div>
<div class="paragraph">
<p>In the folder <code>src/main/kubernetes</code> add <code>pdb.yml</code> file with the following content:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
spec:
  minAvailable: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: another-greeting-app</code></pre>
</div>
</div>
<div class="paragraph">
<p>Typically, you will install <code>src/main/kubernetes/pdb.yml</code> in an Kubernetes/OpenShift environment and will observe that the configuration is rejected because the name of the resource is missing.
However, you can avoid such a scenario by creating an integration test for the <code>PodDisruptionBudget</code> resource defined in the file:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package com.redhat.developers;

import io.fabric8.kubernetes.api.model.policy.v1.PodDisruptionBudget;
import io.fabric8.kubernetes.client.KubernetesClientException;
import io.fabric8.kubernetes.client.server.mock.KubernetesServer;
import io.quarkus.test.junit.DisabledOnNativeImage;
import io.quarkus.test.junit.QuarkusTest;
import io.quarkus.test.kubernetes.client.KubernetesTestServer;
import io.quarkus.test.kubernetes.client.WithKubernetesTestServer;
import org.junit.jupiter.api.Test;

import static org.junit.jupiter.api.Assertions.assertThrows;

@WithKubernetesTestServer<i class="conum" data-value="1"></i><b>(1)</b>
@QuarkusTest
@DisabledOnNativeImage<i class="conum" data-value="2"></i><b>(2)</b>
public class PodDisruptionBudgetTest {

    @KubernetesTestServer<i class="conum" data-value="3"></i><b>(3)</b>
    KubernetesServer mocKubernetesServer;

    @Test
    public void testPdbFromFile() {
        String path = "./src/main/kubernetes/pdb.yml";<i class="conum" data-value="4"></i><b>(4)</b>
        PodDisruptionBudget pdb = mocKubernetesServer.getClient().policy().v1().podDisruptionBudget().load(path).get();
        assertThrows(KubernetesClientException.class, () -&gt; mocKubernetesServer.getClient().policy().v1().podDisruptionBudget().create(pdb));<i class="conum" data-value="5"></i><b>(5)</b>
    }

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Annotate the test as one working in a mocked Kubernetes context.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Exclude this test when running the native executable.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Add the mock Kubernetes server context.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Specify the path to the resource under test.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Try to create the Kubernetes resource based on the configuration inside file.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>By running the test (via ContinuousTesting/IDE/application package) you can get exceptions but also what is wrong with the resource.</p>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="6monitoring.html">Observing Memory/CPU</a></span>
</nav>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="../../_/js/vendor/clipboard.js"></script>
<script src="../../_/js/site.js"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
  </body>
</html>
